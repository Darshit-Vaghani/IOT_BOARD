<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Distribution Board Analytics</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007bff;
            --secondary: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #343a40;
            --light: #f8f9fa;
            --gray: #6c757d;
            --accent: #6610f2;
            --gradient: linear-gradient(135deg, #007bff, #6610f2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            background: var(--light);
            color: var(--dark);
            overflow-x: hidden;
        }

        .container {
            display: flex;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .sidebar {
            width: 250px;
            background: #ffffff;
            border-right: 1px solid #dee2e6;
            padding: 20px;
            position: sticky;
            top: 20px;
            height: calc(100vh - 40px);
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            animation: slideInLeft 0.5s ease-out;
        }

        .sidebar h3 {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar ul li {
            margin: 15px 0;
        }

        .sidebar ul li a {
            color: var(--gray);
            text-decoration: none;
            font-size: 1.1rem;
            transition: color 0.3s ease, transform 0.3s ease;
            display: block;
            padding: 10px;
            border-radius: 8px;
        }

        .sidebar ul li a:hover {
            color: var(--primary);
            transform: translateX(10px);
            background: #e9ecef;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        header {
            background: var(--gradient);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.2);
            text-align: center;
            animation: fadeIn 1s ease-in;
        }

        h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.4rem;
            font-weight: 300;
            opacity: 0.9;
        }

        .section-title {
            font-size: 2.2rem;
            font-weight: 500;
            margin: 50px 0 25px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary);
            position: relative;
            display: inline-block;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 120px;
            height: 3px;
            background-color: var(--accent);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .card {
            background: #ffffff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: slideUp 0.6s ease-out;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .card-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            height: 350px;
            margin-top: 20px;
            width: 100%;
        }

        .gauge-container {
            height: 200px;
            margin: 20px auto;
            width: 200px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            transition: background-color 0.3s ease;
        }

        .stat-item:hover {
            background: #e9ecef;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 1rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .alert-item {
            background: #ffe5e7;
            border: 2px solid var(--danger);
            color: var(--danger);
        }

        .threshold-input, .cost-input {
            padding: 10px;
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            margin-top: 10px;
            transition: border-color 0.3s ease;
            background: #ffffff;
        }

        .threshold-input:focus, .cost-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }

        .threshold-input:invalid, .cost-input:invalid {
            border-color: var(--danger);
        }

        .threshold-item {
            margin-bottom: 15px;
        }

        .set-threshold-btn, .set-cost-btn {
            display: block;
            padding: 10px 20px;
            background: var(--secondary);
            color: white;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            margin: 20px auto 0;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .set-threshold-btn:hover, .set-cost-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .download-btn {
            display: inline-block;
            padding: 15px 30px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            width: fit-content;
            border: none;
        }

        .download-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .map-container {
            height: 350px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                margin-bottom: 20px;
            }

            .main-content {
                padding: 0;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 2.2rem;
            }

            .section-title {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h3>Navigation</h3>
            <ul>
                <li><a href="#real-time-monitoring">Real-Time Monitoring</a></li>
                <li><a href="#energy-consumption">Energy Consumption</a></li>
                <li><a href="#cost-analysis">Cost Analysis</a></li>
                <li><a href="#peak-load-analysis">Peak Load Analysis</a></li>
                <li><a href="#trend-prediction">Trend Prediction</a></li>
                <li><a href="#efficiency-analysis">Efficiency Analysis</a></li>
                <li><a href="#system-overview">System Overview</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header>
                <h1>Smart Distribution Board Analytics</h1>
                <p class="subtitle">Real-time insights and predictive analytics for energy management</p>
            </header>

            <!-- Download Annual Report Button -->
            <button class="download-btn" id="download-annual-report">Download Annual Report</button>

            <!-- Real-Time Monitoring -->
            <h2 class="section-title" id="real-time-monitoring">Real-Time Monitoring</h2>
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Current Load</div>
                        <div class="card-icon">‚ö°</div>
                    </div>
                    <div class="gauge-container" id="load-gauge"></div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="current-power">0</div>
                            <div class="stat-label">Current Power (W)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="current-alert">-</div>
                            <div class="stat-label">Alert Status</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Annual Energy Consumption -->
            <h2 class="section-title" id="energy-consumption">Annual Energy Consumption</h2>
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Monthly Energy Breakdown</div>
                        <div class="card-icon">üìä</div>
                    </div>
                    <div class="chart-container" id="energy-chart"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Energy Metrics</div>
                        <div class="card-icon">üìà</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-energy">0</div>
                            <div class="stat-label">Total Energy (kWh)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="main-energy">0</div>
                            <div class="stat-label">Main Circuit (kWh)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="sub-energy">0</div>
                            <div class="stat-label">Sub Circuit (kWh)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="solar-energy">0</div>
                            <div class="stat-label">Solar Input (kWh)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cost Analysis -->
            <h2 class="section-title" id="cost-analysis">Cost Analysis</h2>
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Monthly Cost Breakdown</div>
                        <div class="card-icon">üí∞</div>
                    </div>
                    <div class="chart-container" id="cost-chart"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Cost Metrics</div>
                        <div class="card-icon">üìä</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-cost">$0</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="main-cost">$0</div>
                            <div class="stat-label">Main Circuit Cost</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="sub-cost">$0</div>
                            <div class="stat-label">Sub Circuit Cost</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="solar-cost">$0</div>
                            <div class="stat-label">Solar Cost</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Set Cost Rates</div>
                        <div class="card-icon">‚öôÔ∏è</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item threshold-item">
                            <div class="stat-label">Main Circuit Rate ($/kWh)</div>
                            <input type="number" id="main-cost-rate" class="cost-input" min="0" step="0.01" value="0.15">
                        </div>
                        <div class="stat-item threshold-item">
                            <div class="stat-label">Sub Circuit Rate ($/kWh)</div>
                            <input type="number" id="sub-cost-rate" class="cost-input" min="0" step="0.01" value="0.12">
                        </div>
                        <div class="stat-item threshold-item">
                            <div class="stat-label">Solar Rate ($/kWh)</div>
                            <input type="number" id="solar-cost-rate" class="cost-input" min="0" step="0.01" value="0.05">
                        </div>
                    </div>
                    <button class="set-cost-btn" onclick="updateCostRates()">Set Cost Rates</button>
                </div>
            </div>

            <!-- Peak Load Analysis -->
            <h2 class="section-title" id="peak-load-analysis">Peak Load Analysis</h2>
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Monthly Peak Power Demand</div>
                        <div class="card-icon">‚ö°</div>
                    </div>
                    <div class="chart-container" id="peak-power-chart"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Peak Load Alerts</div>
                        <div class="card-icon">üö®</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item" id="max-power-alert">
                            <div class="stat-value" id="max-power">0</div>
                            <div class="stat-label">Max Power (W)</div>
                        </div>
                        <div class="stat-item" id="max-kwh-alert">
                            <div class="stat-value" id="max-kwh">0</div>
                            <div class="stat-label">Max Energy (kWh)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="peak-time">-</div>
                            <div class="stat-label">Peak Demand Time</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Set Thresholds</div>
                        <div class="card-icon">‚öôÔ∏è</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item threshold-item">
                            <div class="stat-label">Max Power Threshold (W)</div>
                            <input type="number" id="max-power-threshold" class="threshold-input" min="0" step="1" value="100">
                        </div>
                        <div class="stat-item threshold-item">
                            <div class="stat-label">Max Energy Threshold (kWh)</div>
                            <input type="number" id="max-kwh-threshold" class="threshold-input" min="0" step="0.1" value="100">
                        </div>
                    </div>
                    <button class="set-threshold-btn" onclick="updateThresholds()">Set Thresholds</button>
                </div>
            </div>

            <!-- Trend Prediction -->
            <h2 class="section-title" id="trend-prediction">Energy Trend Prediction</h2>
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Next Month Energy Prediction</div>
                        <div class="card-icon">üîÆ</div>
                    </div>
                    <div class="chart-container" id="trend-chart"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Predicted Metrics</div>
                        <div class="card-icon">üìà</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="predicted-total">0</div>
                            <div class="stat-label">Total Energy (kWh)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="predicted-main">0</div>
                            <div class="stat-label">Main Circuit (kWh)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="predicted-sub">0</div>
                            <div class="stat-label">Sub Circuit (kWh)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="predicted-solar">0</div>
                            <div class="stat-label">Solar Input (kWh)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Efficiency Analysis -->
            <h2 class="section-title" id="efficiency-analysis">System Efficiency</h2>
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Solar Utilization Rate</div>
                        <div class="card-icon">‚òÄÔ∏è</div>
                    </div>
                    <div class="chart-container" id="solar-utilization-chart"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Efficiency Metrics</div>
                        <div class="card-icon">üìã</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="solar-util-rate">0%</div>
                            <div class="stat-label">Solar Utilization</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="load-balance">0%</div>
                            <div class="stat-label">Load Balance</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="pf-efficiency">0%</div>
                            <div class="stat-label">PF Efficiency</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status and Location -->
            <h2 class="section-title" id="system-overview">System Overview</h2>
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Location</div>
                        <div class="card-icon">üìç</div>
                    </div>
                    <div id="map" class="map-container"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">System Status</div>
                        <div class="card-icon">‚öôÔ∏è</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="seal-status">Intact</div>
                            <div class="stat-label">Seal Status</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="uptime">0</div>
                            <div class="stat-label">Uptime (Days)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="alerts">0</div>
                            <div class="stat-label">Alerts Raised</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Additional Download Report Button -->
            <button class="download-btn" id="download-report">Download Report</button>
        </main>
    </div>

    <script>
        'use strict';

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize variables
            let maxPowerThreshold = 100;
            let maxKwhThreshold = 100;
            let mainCostRate = 0.15;
            let subCostRate = 0.12;
            let solarCostRate = 0.05;
            let currentPower = 0;
            let currentAlert = 'None';

            const myHeaders = new Headers();
            myHeaders.append('Content-Type', 'application/json');
            const { jsPDF } = window.jspdf;

            // Log initialization
            console.log('Initializing Smart Distribution Board Analytics');

            // Attach event listeners to download buttons
            const annualReportBtn = document.getElementById('download-annual-report');
            const reportBtn = document.getElementById('download-report');
            if (annualReportBtn) {
                annualReportBtn.addEventListener('click', () => {
                    console.log('Download Annual Report button clicked');
                    generateAnnualReport();
                });
            } else {
                console.error('Annual Report button not found');
            }
            if (reportBtn) {
                reportBtn.addEventListener('click', () => {
                    console.log('Download Report button clicked');
                    generateAnnualReport();
                });
            } else {
                console.error('Download Report button not found');
            }

            // Initialize components
            initializeMap();
            initializeCharts();
            
            startRealTimeMonitoring();

            function initializeMap() {
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('Map container not found');
                    return;
                }
                const map = L.map('map').setView([28.6139, 77.2090], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                L.marker([28.6139, 77.2090]).addTo(map)
                    .bindPopup('Distribution Board Location')
                    .openPopup();
                console.log('Map initialized');
            }

            function initializeCharts() {
                const charts = [
                    { id: 'energy-chart', type: 'bar', data: [], xKey: 'month', yKeys: ['main', 'sub', 'solar'], colors: ['#007bff', '#28a745', '#ffc107'], yLabel: 'Energy (kWh)' },
                    { id: 'cost-chart', type: 'bar', data: [], xKey: 'month', yKeys: ['main', 'sub', 'solar'], colors: ['#007bff', '#28a745', '#ffc107'], yLabel: 'Cost ($)' },
                    { id: 'peak-power-chart', type: 'line', data: [[], [], []], labels: [], seriesNames: ['Main Circuit', 'Sub Circuit', 'Solar'], colors: ['#007bff', '#28a745', '#ffc107'], yLabel: 'Power (W)' },
                    { id: 'solar-utilization-chart', type: 'line', data: [[]], labels: [], seriesNames: ['Solar Utilization'], colors: ['#ffc107'], yLabel: 'Utilization (%)' },
                    { id: 'trend-chart', type: 'line', data: [[]], labels: [], seriesNames: ['Predicted Total'], colors: ['#6610f2'], yLabel: 'Energy (kWh)' },
                    { id: 'load-gauge', type: 'gauge', value: 0 }
                ];

                charts.forEach(chart => {
                    console.log(`Initializing chart: ${chart.id}`);
                    if (chart.type === 'bar') {
                        createBarChart(chart.id, chart.data, chart.xKey, chart.yKeys, chart.colors, chart.yLabel);
                    } else if (chart.type === 'line') {
                        createLineChart(chart.id, chart.data, chart.labels, chart.seriesNames, chart.colors, chart.yLabel);
                    } else if (chart.type === 'gauge') {
                        createGaugeChart(chart.id, chart.value);
                    }
                });
            }

            function updateThresholds() {
                const powerInput = document.getElementById('max-power-threshold');
                const kwhInput = document.getElementById('max-kwh-threshold');

                const powerValue = parseFloat(powerInput.value);
                const kwhValue = parseFloat(kwhInput.value);

                if (!isNaN(powerValue) && powerValue >= 0) {
                    maxPowerThreshold = powerValue;
                } else {
                    powerInput.value = maxPowerThreshold;
                }

                if (!isNaN(kwhValue) && kwhValue >= 0) {
                    maxKwhThreshold = kwhValue;
                } else {
                    kwhInput.value = maxKwhThreshold;
                }

               
                updateRealTimeMonitoring();
                console.log('Thresholds updated:', { maxPowerThreshold, maxKwhThreshold });
            }

            function updateCostRates() {
                const mainRateInput = document.getElementById('main-cost-rate');
                const subRateInput = document.getElementById('sub-cost-rate');
                const solarRateInput = document.getElementById('solar-cost-rate');

                const mainRateValue = parseFloat(mainRateInput.value);
                const subRateValue = parseFloat(subRateInput.value);
                const solarRateValue = parseFloat(solarRateInput.value);

                if (!isNaN(mainRateValue) && mainRateValue >= 0) {
                    mainCostRate = mainRateValue;
                } else {
                    mainRateInput.value = mainCostRate;
                }

                if (!isNaN(subRateValue) && subRateValue >= 0) {
                    subCostRate = subRateValue;
                } else {
                    subRateInput.value = subCostRate;
                }

                if (!isNaN(solarRateValue) && solarRateValue >= 0) {
                    solarCostRate = solarRateValue;
                } else {
                    solarRateInput.value = solarCostRate;
                }

                console.log('Cost rates updated:', { mainCostRate, subCostRate, solarCostRate });
            }

            function simulateRealTimeData() {
                currentPower = (5000 + Math.random() * 2000).toFixed(2);
                currentAlert = currentPower > maxPowerThreshold ? 'High Power' : 'None';
                return { currentPower, currentAlert };
            }

            function startRealTimeMonitoring() {
                updateRealTimeMonitoring();
                setInterval(updateRealTimeMonitoring, 5000);
            }

            function updateRealTimeMonitoring() {
                const realTimeData = simulateRealTimeData();
                currentPower = realTimeData.currentPower;
                currentAlert = realTimeData.currentAlert;

                document.getElementById('current-power').textContent = currentPower;
                document.getElementById('current-alert').textContent = currentAlert;

                const loadPercentage = (currentPower / maxPowerThreshold) * 100;
                createGaugeChart('load-gauge', loadPercentage);

                const alertElement = document.getElementById('current-alert').parentElement;
                alertElement.classList.remove('alert-item');
                if (currentAlert !== 'None') {
                    alertElement.classList.add('alert-item');
                }
                console.log('Real-time data updated:', { currentPower, currentAlert });
            }

            

            function simulateAnnualData() {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const energyData = months.map(month => ({
                    month,
                    main: (200 + Math.random() * 50).toFixed(2),
                    sub: (100 + Math.random() * 30).toFixed(2),
                    solar: (150 + Math.random() * 40).toFixed(2)
                }));
                const peakPowerData = {
                    main: months.map(() => (5000 + Math.random() * 1500).toFixed(2)),
                    sub: months.map(() => (2000 + Math.random() * 1000).toFixed(2)),
                    solar: months.map(() => (2500 + Math.random() * 1200).toFixed(2))
                };
                const solarUtilization = months.map(() => (60 + Math.random() * 30).toFixed(2));
                const data = {
                    energy: energyData,
                    peakPower: peakPowerData,
                    solarUtilization: solarUtilization,
                    system: {
                        sealStatus: Math.random() > 0.9 ? 'Tampered' : 'Intact',
                        uptime: Math.floor(365 * Math.random()),
                        alerts: Math.floor(10 * Math.random()),
                        maxPower: Math.max(...peakPowerData.main.map(parseFloat), ...peakPowerData.sub.map(parseFloat), ...peakPowerData.solar.map(parseFloat)).toFixed(2),
                        maxKWh: Math.max(...energyData.map(d => parseFloat(d.main) + parseFloat(d.sub) + parseFloat(d.solar))).toFixed(2),
                        peakTime: `${Math.floor(Math.random() * 24)}:00`
                    }
                };
                console.log('Simulated annual data:', data);
                return data;
            }

            function predictNextMonth(energyData) {
                const months = energyData.length;
                const x = Array.from({ length: months }, (_, i) => i + 1);
                const yMain = energyData.map(d => parseFloat(d.main));
                const ySub = energyData.map(d => parseFloat(d.sub));
                const ySolar = energyData.map(d => parseFloat(d.solar));

                function linearRegression(x, y) {
                    const n = x.length;
                    const sumX = x.reduce((a, b) => a + b, 0);
                    const sumY = y.reduce((a, b) => a + b, 0);
                    const sumXY = x.reduce((a, b, i) => a + b * y[i], 0);
                    const sumXX = x.reduce((a, b) => a + b * b, 0);

                    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                    const intercept = (sumY - slope * sumX) / n;

                    return slope * (n + 1) + intercept;
                }

                const predictedMain = linearRegression(x, yMain).toFixed(2);
                const predictedSub = linearRegression(x, ySub).toFixed(2);
                const predictedSolar = linearRegression(x, ySolar).toFixed(2);
                const predictedTotal = (parseFloat(predictedMain) + parseFloat(predictedSub) + parseFloat(predictedSolar)).toFixed(2);

                console.log('Prediction:', { predictedMain, predictedSub, predictedSolar, predictedTotal });
                return { predictedMain, predictedSub, predictedSolar, predictedTotal };
            }

            function updateAllData(data) {
                const energyData = data.energy;
                const peakPowerData = data.peakPower;
                const solarUtilization = data.solarUtilization;
                const systemData = data.system;

                const costData = energyData.map(d => ({
                    month: d.month,
                    main: (parseFloat(d.main) * mainCostRate).toFixed(2),
                    sub: (parseFloat(d.sub) * subCostRate).toFixed(2),
                    solar: (parseFloat(d.solar) * solarCostRate).toFixed(2)
                }));

                const prediction = predictNextMonth(energyData);
                const trendData = energyData.map(d => parseFloat(d.main) + parseFloat(d.sub) + parseFloat(d.solar)).concat([parseFloat(prediction.predictedTotal)]);

                // Update charts
                createBarChart('energy-chart', energyData, 'month', ['main', 'sub', 'solar'], ['#007bff', '#28a745', '#ffc107'], 'Energy (kWh)');
                createBarChart('cost-chart', costData, 'month', ['main', 'sub', 'solar'], ['#007bff', '#28a745', '#ffc107'], 'Cost ($)');
                createLineChart('peak-power-chart', [peakPowerData.main, peakPowerData.sub, peakPowerData.solar], ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], ['Main Circuit', 'Sub Circuit', 'Solar'], ['#007bff', '#28a745', '#ffc107'], 'Power (W)');
                createLineChart('solar-utilization-chart', [solarUtilization], ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], ['Solar Utilization'], ['#ffc107'], 'Utilization (%)');
                createLineChart('trend-chart', [trendData], ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Next'], ['Predicted Total'], ['#6610f2'], 'Energy (kWh)');

                // Update stats
                const totalEnergy = energyData.reduce((sum, d) => sum + parseFloat(d.main) + parseFloat(d.sub) + parseFloat(d.solar), 0).toFixed(2);
                document.getElementById('total-energy').textContent = totalEnergy;
                document.getElementById('main-energy').textContent = energyData.reduce((sum, d) => sum + parseFloat(d.main), 0).toFixed(2);
                document.getElementById('sub-energy').textContent = energyData.reduce((sum, d) => sum + parseFloat(d.sub), 0).toFixed(2);
                document.getElementById('solar-energy').textContent = energyData.reduce((sum, d) => sum + parseFloat(d.solar), 0).toFixed(2);

                const totalCost = costData.reduce((sum, d) => sum + parseFloat(d.main) + parseFloat(d.sub) + parseFloat(d.solar), 0).toFixed(2);
                document.getElementById('total-cost').textContent = `$${totalCost}`;
                document.getElementById('main-cost').textContent = `$${costData.reduce((sum, d) => sum + parseFloat(d.main), 0).toFixed(2)}`;
                document.getElementById('sub-cost').textContent = `$${costData.reduce((sum, d) => sum + parseFloat(d.sub), 0).toFixed(2)}`;
                document.getElementById('solar-cost').textContent = `$${costData.reduce((sum, d) => sum + parseFloat(d.solar), 0).toFixed(2)}`;

                document.getElementById('max-power').textContent = systemData.maxPower;
                document.getElementById('max-kwh').textContent = systemData.maxKWh;
                document.getElementById('peak-time').textContent = systemData.peakTime;

                document.getElementById('max-power-alert').classList.remove('alert-item');
                document.getElementById('max-kwh-alert').classList.remove('alert-item');
                if (parseFloat(systemData.maxPower) > maxPowerThreshold) {
                    document.getElementById('max-power-alert').classList.add('alert-item');
                }
                if (parseFloat(systemData.maxKWh) > maxKwhThreshold) {
                    document.getElementById('max-kwh-alert').classList.add('alert-item');
                }

                const solarUtilRate = solarUtilization.reduce((sum, v) => sum + parseFloat(v), 0) / solarUtilization.length;
                const loadBalance = ((parseFloat(energyData[0].main) / totalEnergy) * 100).toFixed(2);
                const pfEfficiency = ((parseFloat(peakPowerData.main[0]) / parseFloat(peakPowerData.main[0])) * 100).toFixed(2);
                document.getElementById('solar-util-rate').textContent = solarUtilRate.toFixed(2) + '%';
                document.getElementById('load-balance').textContent = loadBalance + '%';
                document.getElementById('pf-efficiency').textContent = pfEfficiency + '%';

                document.getElementById('seal-status').textContent = systemData.sealStatus;
                document.getElementById('uptime').textContent = systemData.uptime;
                document.getElementById('alerts').textContent = systemData.alerts;

                document.getElementById('predicted-total').textContent = prediction.predictedTotal;
                document.getElementById('predicted-main').textContent = prediction.predictedMain;
                document.getElementById('predicted-sub').textContent = prediction.predictedSub;
                document.getElementById('predicted-solar').textContent = prediction.predictedSolar;

                console.log('All data updated');
            }

            function generateAnnualReport() {
                const doc = new jsPDF();
                doc.setFontSize(22);
                doc.text('Smart Distribution Board Annual Report', 20, 20);
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 30);

                doc.setFontSize(16);
                doc.text('Real-Time Monitoring', 20, 50);
                doc.setFontSize(12);
                doc.text(`Current Power: ${document.getElementById('current-power').textContent} W`, 20, 60);
                doc.text(`Alert Status: ${document.getElementById('current-alert').textContent}`, 20, 70);

                doc.setFontSize(16);
                doc.text('Energy Consumption Summary', 20, 90);
                doc.setFontSize(12);
                doc.text(`Total Energy: ${document.getElementById('total-energy').textContent} kWh`, 20, 100);
                doc.text(`Main Circuit: ${document.getElementById('main-energy').textContent} kWh`, 20, 110);
                doc.text(`Sub Circuit: ${document.getElementById('sub-energy').textContent} kWh`, 20, 120);
                doc.text(`Solar Input: ${document.getElementById('solar-energy').textContent} kWh`, 20, 130);

                doc.setFontSize(16);
                doc.text('Cost Analysis', 20, 150);
                doc.setFontSize(12);
                doc.text(`Total Cost: ${document.getElementById('total-cost').textContent}`, 20, 160);
                doc.text(`Main Circuit Cost: ${document.getElementById('main-cost').textContent} (Rate: $${mainCostRate}/kWh)`, 20, 170);
                doc.text(`Sub Circuit Cost: ${document.getElementById('sub-cost').textContent} (Rate: $${subCostRate}/kWh)`, 20, 180);
                doc.text(`Solar Cost: ${document.getElementById('solar-cost').textContent} (Rate: $${solarCostRate}/kWh)`, 20, 190);

                doc.setFontSize(16);
                doc.text('Peak Load Analysis', 20, 210);
                doc.setFontSize(12);
                doc.text(`Max Power Demand: ${document.getElementById('max-power').textContent} W (Threshold: ${maxPowerThreshold} W)`, 20, 220);
                doc.text(`Max Energy: ${document.getElementById('max-kwh').textContent} kWh (Threshold: ${maxKwhThreshold} kWh)`, 20, 230);
                doc.text(`Peak Demand Time: ${document.getElementById('peak-time').textContent}`, 20, 240);

                doc.setFontSize(16);
                doc.text('Energy Trend Prediction', 20, 260);
                doc.setFontSize(12);
                doc.text(`Predicted Total: ${document.getElementById('predicted-total').textContent} kWh`, 20, 270);
                doc.text(`Predicted Main: ${document.getElementById('predicted-main').textContent} kWh`, 20, 280);
                doc.text(`Predicted Sub: ${document.getElementById('predicted-sub').textContent} kWh`, 20, 290);
                doc.text(`Predicted Solar: ${document.getElementById('predicted-solar').textContent} kWh`, 20, 300);

                doc.setFontSize(16);
                doc.text('Efficiency Metrics', 20, 320);
                doc.setFontSize(12);
                doc.text(`Solar Utilization: ${document.getElementById('solar-util-rate').textContent}`, 20, 330);
                doc.text(`Load Balance: ${document.getElementById('load-balance').textContent}`, 20, 340);
                doc.text(`PF Efficiency: ${document.getElementById('pf-efficiency').textContent}`, 20, 350);

                doc.setFontSize(16);
                doc.text('System Overview', 20, 370);
                doc.setFontSize(12);
                doc.text(`Seal Status: ${document.getElementById('seal-status').textContent}`, 20, 380);
                doc.text(`Uptime: ${document.getElementById('uptime').textContent} days`, 20, 390);
                doc.text(`Alerts Raised: ${document.getElementById('alerts').textContent}`, 20, 400);

                doc.save('Smart_Distribution_Board_Annual_Report.pdf');
                console.log('Annual report generated');
            }

            function createLineChart(containerId, data, labels, seriesNames, colors, yLabel) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container ${containerId} not found`);
                    return;
                }

                const margin = { top: 30, right: 40, bottom: 60, left: 70 };
                const width = container.clientWidth - margin.left - margin.right || 400;
                const height = 350 - margin.top - margin.bottom;

                d3.select(`#${containerId}`).selectAll('*').remove();
                const svg = d3.select(`#${containerId}`)
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                if (!labels.length || !data[0].length) {
                    console.warn(`No data for ${containerId}`);
                    svg.append('text')
                        .attr('x', width / 2)
                        .attr('y', height / 2)
                        .attr('text-anchor', 'middle')
                        .style('fill', '#6c757d')
                        .text('No Data Available');
                    return;
                }

                const x = d3.scalePoint()
                    .domain(labels)
                    .range([0, width])
                    .padding(0.1);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(data.flat(), d => +d) * 1.2 || 100])
                    .range([height, 0]);

                svg.append('g')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .selectAll('text')
                    .style('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em')
                    .attr('transform', 'rotate(-45)')
                    .style('fill', '#6c757d');

                svg.append('g')
                    .call(d3.axisLeft(y))
                    .selectAll('text')
                    .style('fill', '#6c757d');

                svg.append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 0 - margin.left)
                    .attr('x', 0 - (height / 2))
                    .attr('dy', '1em')
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('fill', '#6c757d')
                    .text(yLabel);

                const line = d3.line()
                    .x((d, i) => x(labels[i]))
                    .y(d => y(d))
                    .defined(d => !isNaN(d));

                data.forEach((series, i) => {
                    svg.append('path')
                        .datum(series)
                        .attr('fill', 'none')
                        .attr('stroke', colors[i])
                        .attr('stroke-width', 2.5)
                        .attr('d', line);

                    svg.selectAll(`.dot-${i}`)
                        .data(series)
                        .enter()
                        .append('circle')
                        .attr('class', `dot-${i}`)
                        .attr('cx', (d, idx) => x(labels[idx]))
                        .attr('cy', d => y(d))
                        .attr('r', 5)
                        .attr('fill', colors[i])
                        .style('stroke', '#fff')
                        .style('stroke-width', 1)
                        .style('opacity', d => isNaN(d) ? 0 : 1);
                });

                const legend = svg.append('g')
                    .attr('transform', `translate(${width - 140}, 10)`);

                seriesNames.forEach((name, i) => {
                    const legendItem = legend.append('g')
                        .attr('transform', `translate(0, ${i * 25})`);
                    legendItem.append('rect')
                        .attr('width', 18)
                        .attr('height', 18)
                        .attr('fill', colors[i]);
                    legendItem.append('text')
                        .attr('x', 24)
                        .attr('y', 9)
                        .attr('dy', '.35em')
                        .style('font-size', '13px')
                        .style('fill', '#6c757d')
                        .text(name);
                });

                console.log(`Line chart rendered: ${containerId}`);
            }

            function createBarChart(containerId, data, xKey, yKeys, colors, yLabel) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container ${containerId} not found`);
                    return;
                }

                const margin = { top: 30, right: 40, bottom: 60, left: 70 };
                const width = container.clientWidth - margin.left - margin.right || 400;
                const height = 350 - margin.top - margin.bottom;

                d3.select(`#${containerId}`).selectAll('*').remove();
                const svg = d3.select(`#${containerId}`)
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                if (!data.length) {
                    console.warn(`No data for ${containerId}`);
                    svg.append('text')
                        .attr('x', width / 2)
                        .attr('y', height / 2)
                        .attr('text-anchor', 'middle')
                        .style('fill', '#6c757d')
                        .text('No Data Available');
                    return;
                }

                const x = d3.scaleBand()
                    .domain(data.map(d => d[xKey]))
                    .range([0, width])
                    .padding(0.2);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(data, d => Math.max(...yKeys.map(key => d[key]))) * 1.2 || 100])
                    .range([height, 0]);

                svg.append('g')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .selectAll('text')
                    .style('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em')
                    .attr('transform', 'rotate(-45)')
                    .style('fill', '#6c757d');

                svg.append('g')
                    .call(d3.axisLeft(y))
                    .selectAll('text')
                    .style('fill', '#6c757d');

                svg.append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 0 - margin.left)
                    .attr('x', 0 - (height / 2))
                    .attr('dy', '1em')
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('fill', '#6c757d')
                    .text(yLabel);

                const barGroups = svg.selectAll('.bar-group')
                    .data(data)
                    .enter()
                    .append('g')
                    .attr('class', 'bar-group')
                    .attr('transform', d => `translate(${x(d[xKey])}, 0)`);

                const barWidth = x.bandwidth() / yKeys.length;
                yKeys.forEach((key, i) => {
                    barGroups.append('rect')
                        .attr('x', i * barWidth)
                        .attr('y', d => y(d[key]))
                        .attr('width', barWidth)
                        .attr('height', d => height - y(d[key]))
                        .attr('fill', colors[i])
                        .style('opacity', 0.9)
                        .on('mouseover', function() { d3.select(this).style('opacity', 1); })
                        .on('mouseout', function() { d3.select(this).style('opacity', 0.9); });
                });

                const legend = svg.append('g')
                    .attr('transform', `translate(${width - 140}, 10)`);

                yKeys.forEach((key, i) => {
                    const legendItem = legend.append('g')
                        .attr('transform', `translate(0, ${i * 25})`);
                    legendItem.append('rect')
                        .attr('width', 18)
                        .attr('height', 18)
                        .attr('fill', colors[i]);
                    legendItem.append('text')
                        .attr('x', 24)
                        .attr('y', 9)
                        .attr('dy', '.35em')
                        .style('font-size', '13px')
                        .style('fill', '#6c757d')
                        .text(key);
                });

                console.log(`Bar chart rendered: ${containerId}`);
            }

            function createGaugeChart(containerId, value) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container ${containerId} not found`);
                    return;
                }

                const width = 200;
                const height = 200;
                const radius = Math.min(width, height) / 2;

                d3.select(`#${containerId}`).selectAll('*').remove();
                const svg = d3.select(`#${containerId}`)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .append('g')
                    .attr('transform', `translate(${width / 2}, ${height / 2})`);

                const arc = d3.arc()
                    .innerRadius(radius * 0.6)
                    .outerRadius(radius * 0.8);

                const backgroundArc = arc({
                    startAngle: -Math.PI / 2,
                    endAngle: Math.PI / 2
                });

                svg.append('path')
                    .attr('d', backgroundArc)
                    .attr('fill', '#dee2e6');

                const valueArc = arc({
                    startAngle: -Math.PI / 2,
                    endAngle: -Math.PI / 2 + (value / 100) * Math.PI
                });

                svg.append('path')
                    .attr('d', valueArc)
                    .attr('fill', value > 80 ? '#dc3545' : value > 50 ? '#ffc107' : '#28a745');

                svg.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', '0.35em')
                    .style('font-size', '20px')
                    .style('fill', '#343a40')
                    .text(`${Math.round(value)}%`);

                console.log(`Gauge chart rendered: ${containerId}`);
            }
        });

        updateAllData({
    energy: [{ month: "Jan", main: "200.45", sub: "100.12", solar: "150.78" }],
    peakPower: { main: ["5000.23"], sub: ["2000.67"], solar: ["2500.12"] },
    solarUtilization: ["60.45"],
    system: {
        sealStatus: "Intact",
        uptime: 30,
        alerts: 99,
        maxPower: "5000.23",
        maxKWh: "451.35",
        peakTime: "14:00"
    },
    realTime: { currentPower: "5500.12", currentAlert: "High Power" }
});
    </script>
</body>
</html>